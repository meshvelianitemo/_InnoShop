version: "3.9"

services:

  # -------- User DB --------
  user-db:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: user-db
    environment:
      ACCEPT_EULA: "Y"
      SA_PASSWORD: ${USER_DB_PASSWORD}
    healthcheck:
      test: /opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P ${USER_DB_PASSWORD} -Q "SELECT 1"
      interval: 10s
      timeout: 5s
      retries: 5
    ports:
      - "1433:1433"
    volumes:
      - user-db-data:/var/opt/mssql
    networks:
      - inno-network

  # -------- User API --------
  user-api:
    build: ./UserService
    container_name: user-api
    depends_on:
      user-db:
        condition: service_healthy
    environment:
      ConnectionStrings__DefaultConnectionString: "Server=user-db,1433;Database=UserManagementDb;User Id=sa;Password=${USER_DB_PASSWORD};TrustServerCertificate=True;"
      JwtSettings__validIssuer: "${JWT_VALID_ISSUER}"
      JwtSettings__validAudience: "${JWT_VALID_AUDIENCE}"
      JwtSettings__Key: "${JWT_KEY}"
      EmailSettings__Address: "${EMAIL_ADDRESS}"
      EmailSettings__Password: "${EMAIL_PASSWORD}"
      EmailSettings__SmtpHost: "${EMAIL_SMTP_HOST}"
      EmailSettings__Port: "${EMAIL_PORT}"
    ports:
      - "5001:80"
    networks:
      - inno-network

  # -------- Product DB --------
  product-db:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: product-db
    environment:
      ACCEPT_EULA: "Y"
      SA_PASSWORD: ${PRODUCT_DB_PASSWORD}
    healthcheck:
      test: /opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P ${PRODUCT_DB_PASSWORD} -Q "SELECT 1"
      interval: 10s
      timeout: 5s
      retries: 5
    ports:
      - "1434:1433"
    volumes:
      - product-db-data:/var/opt/mssql
    networks:
      - inno-network

  # -------- Product API --------
  product-api:
    build: ./ProductService
    container_name: product-api
    depends_on:
      product-db:
        condition: service_healthy
    environment:
      ConnectionStrings__DefaultConnection: "Server=product-db,1433;Database=ProductManagementDb;User Id=sa;Password=${PRODUCT_DB_PASSWORD};TrustServerCertificate=True;"
      JwtSettings__validIssuer: "${JWT_VALID_ISSUER}"
      JwtSettings__validAudience: "${JWT_VALID_AUDIENCE}"
      JwtSettings__Key: "${JWT_KEY}"
      EmailSettings__Address: "${EMAIL_ADDRESS}"
      EmailSettings__Password: "${EMAIL_PASSWORD}"
      EmailSettings__SmtpHost: "${EMAIL_SMTP_HOST}"
      EmailSettings__Port: "${EMAIL_PORT}"
    ports:
      - "5002:80"
    networks:
      - inno-network

# =========================================
# Persistent volumes
# =========================================
volumes:
  user-db-data:
  product-db-data:

# =========================================
# Network
# =========================================
networks:
  inno-network:
    driver: bridge
